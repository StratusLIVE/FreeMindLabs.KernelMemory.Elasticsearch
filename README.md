# Elasticsearch Memory Storage for Kernel Memory
**By Free Mind Labs, Inc.** - *Dive into your Stream*

[![License: MIT](https://img.shields.io/github/license/microsoft/kernel-memory)](https://github.com/freemindlabsinc/FreeMindLabs.SemanticKernel/blob/main/LICENSE)

Use [Elasticsearch](https://www.elastic.co/) as vector storage for [Microsoft](https://www.microsoft.ms) **[Kernel Memory](https://github.com/microsoft/semantic-memory)** (KM)

Kernel Memory (KM) is an open-source service and plugin specialized in the efficient indexing of datasets through custom continuous data hybrid pipelines.

<img src="/content/images/Pipelines.jpg"/>

Utilizing advanced embeddings and LLMs, the system enables Natural Language querying for obtaining answers from the indexed data, complete with citations and links to the original sources.

<img src="/content/images/RAG.jpg"/>


This repository contains the **Elasticsearch adapter** that allows KM to use Elasticsearch as vector database, thus allowing developers to perform hybrid and semantic search directly on  Elasticsearch, on-premise or in the cloud.

Tokenization can be done using commercial models from OpenAI, Azure Open AI or open sourece models hosted on Hugging Face, including those used by [Sentence Transformers](https://sbert.net/)

<p align="center">
    <img src="https://sbert.net/_static/logo.png" width=200 />
</p>

## Goals
1. To implement an maintain an open source Elasticsearch [IMemoryDB](https://github.com/microsoft/kernel-memory/blob/adce865a472728f2549428cf6b82ca79a601582b/service/Abstractions/MemoryStorage/IMemoryDb.cs#L9) connector for Kernel Memory.
    1. Free Mind Labs require such connector to finish developing [Videomatic](https://github.com/freemindlabsinc/videomatic).
    1. KM can also be used as memory store for [Semantic Kernel](https://github.com/microsoft/semantic-kernel).
    1. The basic connector (i.e. the complete implementation of IMemoryDb) will be free of charge and open source.

1. In the future we hope to add additional features (e.g. advanced search options for pre and post filtering, analytics, ES-specific features, etc.) that could generate some revenue to support this and other projects. 
    1. Patreon?
    1. Github domantions?
    1. Other?

We'd love to hear what you think about this.

Click on :notebook: [DIARY](DIARY.md) to read daily thoughts and what is happening behind the scenes.

## Show me the money

Here are some screenshots of the connector in action.
The data was generated running the tests in the solution.

![Behaves Like](/content/images/BehavesLike.jpg)
Click [here](tests/UnitTests/MemoryStorage/MemoryStorageTests.cs) to see the source code of the test.

![Carbon Bonds to](/content/images/CarbonBondTo.jpg)
Click [here](tests/UnitTests/Serverless/ServerlessTest.cs) to see the source code of the test.

### Mappings
The examples uses the OpenAI's text-embedding-ada-002. 
It is possible to use any other embedding model supported by SK (e.g. Azure Open AI and Hugging Face).

![Mappings](/content/images/Mappings.jpg)

### Kibana
Here are some screenshots of the data stored in ES, after running the tests in the solution.

![All Documents](/content/images/DataPageAllRows.jpg)

![Data Page 1](/content/images/DataPage1.jpg)
![Data Page 2](/content/images/DataPage2.jpg)

### KNN Query
Here's an example of how to run semantic search directly on ES.

![KNN Query](/content/images/KnnQuery.jpg)


## Pre-requisites
1. A running instance of Elasticsearch 8 
    - *Semantic search does not seem to be available in v7*.
    - Please follow the instructions at [Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/8.11/install-elasticsearch.html) to install and configure Elasticsearch.
1. Make sure you have the following information, as they will be needed for configuration:
    1. The **user name** and **password** to connect to ES.
    1. The **certificate fingerprint** generated by the ES server.    

## Configuration
The configuration instructions can be found [here](CONFIGURATION.md).




## Current status
1. The connector is currently in development and not ready for production use yet.
1. The connector is not yet available as a NuGet package.

## Timeline
1. We hope to complete this project and the associated documentation by the end of 2023.


## Challenges
The new API in the Elasticsearch client is not yet feature complete and there are bugs.

1. AutoMap(),etc. missing
    1. [CreateIndexDescriptor Mappings -> Map Api usage issue #7929](https://github.com/elastic/elasticsearch-net/issues/7929)
    1. [FEATURE - Support AutoMap to allow creation of mappings using type inference #6610](https://github.com/elastic/elasticsearch-net/issues/6610)
        1. flobernd comment on Aug 17 suggests this:
```
var mapResponse = client.Indices.PutMapping("index", x => x
    .Properties<Person>(p => p
        .DenseVector(x => x.Data, d => d
            .Index(true)
            .Similarity("dot_product"))));
```

## Resources

1. Elastic's official docs on the client.
    1. NEST 7.17: https://www.elastic.co/guide/en/elasticsearch/client/net-api/7.17/nest-getting-started.html
    1. New client 8.9: https://www.elastic.co/guide/en/elasticsearch/client/net-api/8.9/introduction.html
        1. This client is not yet feature complete.
            1. Look here for details: https://www.elastic.co/guide/en/elasticsearch/client/net-api/current/release-notes-8.0.0.html
        1. In addition, the docs are not up to date. For some stuff we need to lok at NEST's docs.

1. [Elasticsearch.net Github repository](https://github.com/elastic/elasticsearch-net)    


1. Semantic Kernel/Memory-Kernel
    1. [Introduction to Semantic Memory (feat. Devis Lucato) | Semantic Kernel](https://www.youtube.com/watch?v=5JYW_uAxwYM)
    1. [11.29.2023 - Semantic Kernel Office Hours (US/Europe Region)](https://www.youtube.com/watch?v=JSca9mVUUJo)